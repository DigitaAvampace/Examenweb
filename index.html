<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Examen Interactivo</title>
  <style>
    /* Estilos básicos */
    body { font-family: Arial, sans-serif; margin: 20px; }
    .pregunta { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    .resultado { margin-top: 20px; font-weight: bold; }
    .correcta { color: green; }
    .incorrecta { color: red; }
    .detalle { margin-bottom: 10px; }
    button { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Examen Interactivo</h1>
  <!-- Sección para elegir el examen -->
  <div id="examenSeleccion"></div>
  <!-- Sección que contendrá el examen -->
  <div id="contenidoExamen" style="display:none;"></div>
  <!-- Sección para mostrar resultados -->
  <div id="resultado"></div>
  <!-- Sección para revisar errores (inicialmente oculta) -->
  <div id="revisarErrores" style="display:none;"></div>

  <script>
    // Paso 1: Define la URL RAW del JSON en GitHub (asegúrate de que sea la URL RAW)
    const urlExamen = 'https://raw.githubusercontent.com/DigitaAvampace/Examenweb/main/examen.json';
    
    let examenesData = null;   // Aquí se almacenará el JSON completo
    let examenActual = null;   // Examen seleccionado

    // Cargar el JSON desde GitHub
    fetch(urlExamen)
      .then(response => {
        if (!response.ok) {
          throw new Error('No se pudo cargar el JSON. ¡Ojo! Revisa que uses la URL RAW y que el repositorio sea público.');
        }
        return response.json();
      })
      .then(data => {
        // Asegúrate de que el JSON tenga la propiedad "examenes"
        if (!data.examenes) {
          throw new Error('El JSON no tiene la propiedad "examenes".');
        }
        examenesData = data.examenes;
        mostrarListadoExamenes();
      })
      .catch(error => {
        document.body.innerHTML = '<p>Error al cargar el examen: ' + error.message + '</p>';
      });

    // Paso 2: Mostrar la lista de exámenes disponibles
    function mostrarListadoExamenes() {
      const div = document.getElementById('examenSeleccion');
      div.innerHTML = '<h2>Elige el examen:</h2>';
      examenesData.forEach((examen, index) => {
        const btn = document.createElement('button');
        btn.innerText = examen.titulo;
        btn.onclick = () => cargarExamen(index);
        div.appendChild(btn);
        div.appendChild(document.createElement('br'));
      });
    }

    // Paso 3: Cargar el examen seleccionado y mostrarlo
    function cargarExamen(indice) {
      examenActual = examenesData[indice];
      // Oculta la lista de exámenes
      document.getElementById('examenSeleccion').style.display = 'none';
      // Muestra el contenido del examen
      const divContenido = document.getElementById('contenidoExamen');
      divContenido.style.display = 'block';
      let html = `<h2>${examenActual.titulo}</h2>`;
      html += `<p>${examenActual.instrucciones}</p>`;
      // Para cada pregunta se muestra el enunciado y las opciones (se espera que sean A, B, C, D)
      examenActual.preguntas.forEach((pregunta, i) => {
        html += `<div class="pregunta">
                   <p><strong>Pregunta ${pregunta.numero}:</strong> ${pregunta.pregunta}</p>`;
        for (const [clave, opcion] of Object.entries(pregunta.opciones)) {
          html += `<label>
                     <input type="radio" name="pregunta${i}" value="${clave}" required>
                     ${clave}) ${opcion}
                   </label><br>`;
        }
        html += `</div>`;
      });
      html += `<button onclick="enviarRespuestas()">Enviar Respuestas</button>`;
      divContenido.innerHTML = html;
    }

    // Paso 4: Enviar respuestas, calcular puntaje y mostrar resultados
    function enviarRespuestas() {
      let puntaje = 0;
      let total = examenActual.preguntas.length;
      let detalles = '';
      // Recorremos cada pregunta para comparar la respuesta del usuario con la correcta
      examenActual.preguntas.forEach((pregunta, i) => {
        const radios = document.getElementsByName(`pregunta${i}`);
        let respuestaUsuario = null;
        radios.forEach(radio => {
          if (radio.checked) {
            respuestaUsuario = radio.value;
          }
        });
        // La respuesta correcta se extrae del objeto "respuestas_correctas" (clave = número de pregunta como string)
        const respuestaCorrecta = examenActual.respuestas_correctas[String(pregunta.numero)];
        if (respuestaUsuario === respuestaCorrecta) {
          puntaje++;
          detalles += `<div class="detalle">Pregunta ${pregunta.numero}: <span class="correcta">Correcto</span></div>`;
        } else {
          detalles += `<div class="detalle">Pregunta ${pregunta.numero}: <span class="incorrecta">Incorrecto</span> (Tu respuesta: ${respuestaUsuario || 'Ninguna'} - Correcta: ${respuestaCorrecta})</div>`;
        }
      });
      // Muestra el resultado
      const divResultado = document.getElementById('resultado');
      divResultado.innerHTML = `<h2>Resultado</h2>
                                <p>Puntaje: ${puntaje} de ${total}</p>
                                ${detalles}
                                <button onclick="mostrarRevisar()">Revisar Errores</button>
                                <button onclick="location.reload()">Reiniciar Examen</button>`;
      // Oculta el contenido del examen
      document.getElementById('contenidoExamen').style.display = 'none';
    }

    // Paso 5: Mostrar detalles y explicaciones de las respuestas incorrectas
    function mostrarRevisar() {
      // Se obtiene el banco de explicaciones para este examen usando su título
      const explicaciones = (typeof banco_explicaciones !== 'undefined' && banco_explicaciones[examenActual.titulo])
                              ? banco_explicaciones[examenActual.titulo]
                              : {};
      let html = '<h2>Revisión de Errores</h2>';
      examenActual.preguntas.forEach((pregunta, i) => {
        const radios = document.getElementsByName(`pregunta${i}`);
        let respuestaUsuario = null;
        radios.forEach(radio => {
          if (radio.checked) {
            respuestaUsuario = radio.value;
          }
        });
        const respuestaCorrecta = examenActual.respuestas_correctas[String(pregunta.numero)];
        if (respuestaUsuario !== respuestaCorrecta) {
          html += `<div class="pregunta">
                     <p><strong>Pregunta ${pregunta.numero}:</strong> ${pregunta.pregunta}</p>
                     <p>Tu respuesta: <span class="incorrecta">${respuestaUsuario || 'Ninguna'}</span></p>
                     <p>Respuesta correcta: <span class="correcta">${respuestaCorrecta}</span></p>
                     <p>Explicación: ${explicaciones[String(pregunta.numero)] || 'No hay explicación disponible.'}</p>
                   </div>`;
        }
      });
      document.getElementById('revisarErrores').style.display = 'block';
      document.getElementById('revisarErrores').innerHTML = html;
    }
  </script>
</body>
</html>
